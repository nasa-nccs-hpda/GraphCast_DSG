name: CI to Dockerhub - Multi-arch

on:
  release:
    types: [published]  # Trigger only when a release is created
  workflow_dispatch: # Keep only manual trigger

jobs:
  docker-amd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Prune docker images and swap
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo apt clean
          docker image prune -a -f
          df -h

      - name: Set build versions
        id: set_versions
        env:
          DEP_REPO: nasa-nccs-hpda/GraphCast_DSG
        run: |
          DEP_TAG=$(curl -s https://api.github.com/repos/${DEP_REPO}/releases/latest | jq -r .tag_name)
          echo "GrapCastDSG_TAG=$DEP_TAG" >> $GITHUB_ENV
          echo "VERSION_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          echo "Using ${DEP_REPO} release tag: $DEP_TAG"
          echo "Workflow release version: ${GITHUB_REF#refs/tags/}"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          file: ./requirements/Dockerfile
          push: true
          tags: nasanccs/graphcast-dsg:${{ env.GraphCastDSG_TAG }}-amd64
          build-args: |
            GraphCastDSG_TAG=${{ env.GraphCastDSG_TAG }}

  manifest:
    needs: [docker-amd]
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set build versions
        id: set_versions
        env:
          DEP_REPO: nasa-nccs-hpda/GraphCast_DSG
        run: |
          DEP_TAG=$(curl -s https://api.github.com/repos/${DEP_REPO}/releases/latest | jq -r .tag_name)
          echo "GraphCastDSG_TAG=$DEP_TAG" >> $GITHUB_ENV
          echo "VERSION_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          echo "Using ${DEP_REPO} release tag: $DEP_TAG"
          echo "Workflow release version: ${GITHUB_REF#refs/tags/}"

      - name: Extract amd64 digest
        run: |
          AMD_DIGEST=$(docker buildx imagetools inspect nasanccs/graphcast-dsg:${{ env.GraphCastDSG_TAG }}-amd64 \
            --format '{{range .Manifest.Manifests}}{{if eq .Platform.Architecture "amd64"}}{{.Digest}}{{end}}{{end}}')
          echo "AMD_DIGEST=$AMD_DIGEST" >> $GITHUB_ENV

      - name: Create and push manifest
        run: |
          # latest -> amd64 only
          docker manifest create nasanccs/graphcast-dsg:latest \
            nasanccs/graphcast-dsg@${AMD_DIGEST}
          docker manifest push nasanccs/graphcast-dsg:latest

          # version tag -> amd64 only
          docker manifest create nasanccs/graphcast-dsg:${{ env.GraphCastDSG_TAG }} \
            nasanccs/graphcast-dsg@${AMD_DIGEST}
          docker manifest push nasanccs/graphcast-dsg:${{ env.GraphCastDSG_TAG }}
